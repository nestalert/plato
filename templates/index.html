<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Chatbot Client</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chat-box::-webkit-scrollbar {
            width: 8px;
        }
        #chat-box::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; 
            border-radius: 4px;
        }
        #chat-box::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: currentColor;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-widget-enter {
            animation: slideIn 0.3s ease-out;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">University Login</h1>

            <div id="login-container">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Enter your login information, or leave blank to login as guest.</h2>
                <div id="login-error" class="mb-4 text-red-600 font-medium hidden"></div>
                
                <div class="mb-4">
                    <label for="uname-input" class="block text-sm font-medium text-gray-700 mb-1">Username (uname)</label>
                    <input type="text" id="uname-input" value="ice1"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                
                <div class="mb-6">
                    <label for="pwd-input" class="block text-sm font-medium text-gray-700 mb-1">Password (pwd)</label>
                    <input type="password" id="pwd-input" value="abc123"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                
                <button onclick="initBot()"
                        class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Connect
                </button>
                
                <div id="loading-spinner" class="mt-4 text-center hidden">
                    <div class="animate-spin inline-block w-6 h-6 border-4 border-indigo-500 border-t-transparent rounded-full" role="status"></div>
                    <span class="ml-2 text-sm text-gray-500">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Website Content -->
    <div id="main-content" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1 class="text-3xl font-bold text-gray-900">Welcome to Our Website</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="bg-white rounded-lg shadow-md p-8 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">About Us</h2>
                <p class="text-gray-600 mb-4">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                </p>
                <p class="text-gray-600 mb-4">
                    Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow-md p-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Our Services</h3>
                    <p class="text-gray-600">
                        We provide excellent services to help you achieve your goals. Our team is dedicated to delivering quality solutions tailored to your needs.
                    </p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Contact Information</h3>
                    <p class="text-gray-600">
                        Need help? Our support team is available 24/7. Click the chat button in the corner to speak with our AI assistant PLATO.
                    </p>
                </div>
            </div>
        </main>

        <!-- Chat Button -->
        <button id="chat-toggle-btn" onclick="toggleChat()" 
                class="fixed bottom-6 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center z-40">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        </button>

        <!-- Chat Widget -->
        <div id="chat-widget" class="fixed bottom-24 right-6 w-96 bg-white rounded-xl shadow-2xl hidden z-40">
            <div class="bg-indigo-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center">
                <h2 class="text-lg font-semibold">PLATO Assistant</h2>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="chat-box" class="h-96 bg-gray-100 p-3 overflow-y-scroll space-y-2">
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <div class="flex mb-2">
                    <input type="text" id="user-input" placeholder="Type your message..." disabled
                           class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <button onclick="sendMessage()" disabled id="send-button"
                            class="p-3 bg-indigo-600 text-white rounded-r-lg shadow-md hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                        Send
                    </button>
                </div>
                <button onclick="correctResponse()"
                        id="correct-button"
                        class="w-full py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-200 disabled:opacity-50">
                    Correct Response
                </button>
            </div>
        </div>
    </div>

    <script>
    const loginModal = document.getElementById('login-modal');
    const mainContent = document.getElementById('main-content');
    const chatWidget = document.getElementById('chat-widget');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const loginError = document.getElementById('login-error');
    const loadingSpinner = document.getElementById('loading-spinner');

    let lastUserMessage = "";
    let isAwaitingCorrection = false;
    let chatOpen = false;

    // Allow 'Enter' key to send message only when chat is active
    userInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !sendButton.disabled) {
            event.preventDefault(); 
            sendMessage();
        }
    });

    function toggleChat() {
        chatOpen = !chatOpen;
        if (chatOpen) {
            chatWidget.classList.remove('hidden');
            chatWidget.classList.add('chat-widget-enter');
            userInput.focus();
        } else {
            chatWidget.classList.add('hidden');
        }
    }

    function displayMessage(sender, text, isSystem = false) {
        const chatBox = document.getElementById('chat-box');
        const p = document.createElement('p');

        let senderClass = sender === 'You' ? 'text-right' : 'text-left';
        let bubbleClass = sender === 'You' 
            ? 'bg-indigo-500 text-white ml-auto' 
            : (isSystem ? 'bg-red-100 text-red-800' : 'bg-white text-gray-800 mr-auto border border-gray-200');

        p.className = `max-w-xs md:max-w-sm px-4 py-2 rounded-xl shadow-sm inline-block ${bubbleClass}`;
        const outerDiv = document.createElement('div');
        outerDiv.className = `${senderClass} flex`;

        let formattedText = text.replace(/\n/g, '<br>');
        const urlRegex = /(\b(https?:\/\/[^\s]+))/g;
        formattedText = formattedText.replace(urlRegex, url => 
            `<a href="${url}" target="_blank" class="text-indigo-600 underline">${url}</a>`
        );
        
        p.innerHTML = isSystem ? `<strong>${sender}:</strong> ${formattedText}` : formattedText; 
        outerDiv.appendChild(p);
        chatBox.appendChild(outerDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function displayTypingMessage(sender, text, isSystem = false) {
        const chatBox = document.getElementById('chat-box');
        const p = document.createElement('p');
        const outerDiv = document.createElement('div');
        let senderClass = sender === 'You' ? 'text-right' : 'text-left';
        let bubbleClass = sender === 'You' 
            ? 'bg-indigo-500 text-white ml-auto' 
            : (isSystem ? 'bg-red-100 text-red-800' : 'bg-white text-gray-800 mr-auto border border-gray-200');

        p.className = `max-w-xs md:max-w-sm px-4 py-2 rounded-xl shadow-sm inline-block ${bubbleClass}`;
        outerDiv.className = `${senderClass} flex`;
        outerDiv.appendChild(p);
        chatBox.appendChild(outerDiv);

        const cursor = document.createElement('span');
        cursor.className = 'typing-cursor';
        p.appendChild(cursor);

        let currentText = '';
        const characters = text.split('');
        for (let ch of characters) {
            currentText += ch;
            let formatted = currentText.replace(/\n/g, '<br>');
            const urlRegex = /(\b(https?:\/\/[^\s]+))/g;
            formatted = formatted.replace(urlRegex, url => 
                `<a href="${url}" target="_blank" class="text-indigo-600 underline">${url}</a>`
            );
            p.innerHTML = (isSystem ? `<strong>${sender}:</strong> ` : '') + formatted;
            p.appendChild(cursor);
            chatBox.scrollTop = chatBox.scrollHeight;
            await new Promise(res => setTimeout(res, 5));
        }
        cursor.remove();
    }

    async function initBot() {
        const uname = document.getElementById('uname-input').value.trim();
        const pwd = document.getElementById('pwd-input').value.trim();
        loadingSpinner.classList.remove('hidden');
        loginError.classList.add('hidden');

        try {
            const res = await fetch(`/init_bot?uname=${encodeURIComponent(uname)}&pwd=${encodeURIComponent(pwd)}`);
            const data = await res.json();
            if (res.ok) {
                loginModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userInput.disabled = false;
                sendButton.disabled = false;
                await displayTypingMessage('Bot', data.welcome_message);
                await displayTypingMessage('Bot', "My name is PLATO, what can I help you with today?");
            } else {
                loginError.textContent = `Initialization failed: ${data.message || 'Unknown error'}`;
                loginError.classList.remove('hidden');
            }
        } catch (e) {
            console.error(e);
            loginError.textContent = 'Network error: could not connect.';
            loginError.classList.remove('hidden');
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        displayMessage('You', message);
        userInput.value = '';

        if (isAwaitingCorrection) {
            await sendCorrection(message);
            isAwaitingCorrection = false;
            return;
        }

        lastUserMessage = message;
        userInput.disabled = true;
        sendButton.disabled = true;
        
        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message })
            });
            const data = await res.json();
            await displayTypingMessage('Bot', data.response);
        } catch (err) {
            console.error(err);
            displayMessage('System', 'Error connecting to the bot.', true);
        } finally {
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }
    }

    async function correctResponse() {
        if (!lastUserMessage) {
            displayMessage('System', 'No previous user message to correct.', true);
            return;
        }

        let intents = [];
        try {
            const res = await fetch('/get_intents');
            const data = await res.json();
            if (res.ok && data.intents) {
                intents = data.intents;
            } else {
                throw new Error(data.error || "No intents received");
            }
        } catch (err) {
            console.error("Error fetching intents:", err);
            displayMessage('System', 'Failed to fetch available intents.', true);
            return;
        }

        let botMsg = "What should the correct intent be?\nAvailable intents:\n";
        intents.forEach((intent, i) => {
            botMsg += `  ${i + 1}. ${intent}\n`;
        });

        await displayTypingMessage('Bot', botMsg);
        isAwaitingCorrection = true;
    }

    async function sendCorrection(correctIntent) {
        try {
            const res = await fetch('/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    last_user_input: lastUserMessage,
                    correct_intent: correctIntent
                })
            });
            const data = await res.json();
            if (res.ok) {
                await displayTypingMessage('Bot', data.message);
                lastUserMessage = "";
            } else {
                await displayTypingMessage('Bot', data.error);
            }
        } catch (error) {
            console.error('Feedback error:', error);
            await displayTypingMessage('System', 'Error sending feedback to server.', true);
        }
    }
</script>
</body>
</html>